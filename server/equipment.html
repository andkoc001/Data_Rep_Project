<!DOCTYPE html>
<!-- Data Representation Project, GMIT 2020 -->
<!-- Author: Andrzej Kocielski, G00376291@gmit.ie -->
<!-- Lecturer: dr Andrew Beatty -->

<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<head>
    <title>Data Rep Project - Autonomous Maintenance</title>
    <meta charset="UTF-8">
    <meta name="description" content="Data Representation Project, GMIT 2020">
    <meta name="author" content="Andrzej Kocielski, G00376291@gmit.ie">

    <!-- Bootstrap style file -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- Reference to external style file (overrides the bootstrap style, because it is placed below in this file -->
    <link rel="stylesheet" href="style.css" type="text/css" />
    <!-- AJAX reference -->
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.5.1.js"></script>
    <!-- https://www.faviconcodegenerator.com/prevent-favicon-404-error.php -->
    <!-- <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo="> -->
</head>

<body>
    <header>
        <div>
            <h1 class="logo_title">Equipment Autonomous Maintenance</h1>
            <div class="picture">
                <img src="https://diginomica.com/sites/default/files/styles/article_images_desktop/public/images/2019-09/shutterstock-%20wilaporn1973-1503679208.jpg?itok=NZVM6aIy"
                    alt="Source: https://diginomica.com/sites/default/files/styles/article_images_desktop/public/images/2019-09/shutterstock-%20wilaporn1973-1503679208.jpg?itok=NZVM6aIy" /></br>
                <div class="caption"> Image source: <a
                        href="https://diginomica.com/fail-early-fail-often-manufacturing-mantra-ai-age"
                        target="_blank">diginomica.com</a></div>
            </div>
        </div>

        <!-- Top navigation bar -->
        <nav id="topnav">
            <!-- The top bar menu consists of unordered list (ul) elements (list items, li), styled with the CSS -->
            <ul class="menu">
                <li><a href="../templates/index.html">Start</a></li>
                <li><a href="#">Equipment</a></li> <!-- This link is active, but does not require reloading the page -->
                <li><a href="#">Suppliers</a></li>
            </ul>
        </nav>
    </header>

    <main class="mainsection">
        <section class="core">
            <h1>List of equipment</h1>
            <div style="margin-bottom: 8px; width: 950px;">
                <button id="showTableButton" style="margin: 0px 10px;" type="button" onclick="showTable()">Show
                    table</button>
                <button id="showCreateButton" style="margin: 0px 10px;" type="button" onclick="showCreate()">Create a
                    new entry</button>
                <button id="showExportButton" style="display: none;" type="button" onclick="doExport()">Export to
                    file</button>
            </div>
            <div>
                <table class="table" id="equipmentTable" style="color: #ddd; display: none;">
                    <tr style="color: aquamarine;">
                        <th>id</th>
                        <th>Category</th>
                        <th>Name</th>
                        <th>Supplier</th>
                        <th>Price</th>
                        <!--
                            <th>Cost in BitCoin</th>
                        -->
                        <th>Update</th>
                        <th>Delete</th>
                    </tr>
                </table>
            </div>
        </section>

        <section>
            <form>
                <!-- Hide the form initially -->
                <div class="core" id='createUpdateForm' style="display:none">
                    <h2><span id="createLabel">Create a new</span><span id="updateLabel">Update existing</span>
                        Item</h2>

                    <!-- hide id field -->
                    <input type="hidden" name="id" />

                    <!-- Category part of form -->
                    <span style="float: left;">Select category of the equipment</span>
                    <select type="text" class="form-control" id="formInputCategory" placeholder="Category">
                        <option value="Tier 1">Tier 1</option>
                        <option value="Tier 2">Tier 2</option>
                        <option value="Auxiliary">Auxiliary</option>
                        <option value="Spare">Spare</option>
                    </select>

                    <!-- Name part of form -->
                    <span style="float: left; margin-top: 6px;">Name of the equipment</span>
                    <input type="text" class="form-control" id="formInputName" placeholder="Name">
                    <!-- Name part of form -->
                    <span style="float: left; margin-top: 6px;">Name of the Supplier</span>
                    <input type="text" class="form-control" id="formInputName" placeholder="Supplier">
                    <!-- Price part of form -->
                    <span style="float: left; margin-top: 6px;">Price in euro</span>
                    <input type="number" class="form-control" id="formInputPrice" placeholder="Price EUR">

                    <!-- Create and update buttons -->
                    <button type="button" id="doCreateButton" onclick="doCreate()"">Create</button>
                    <button type=" button" id="doUpdateButton" onclick="doUpdate()">Update</button>
                </div>
            </form>
        </section>

        <section class="core">
            <h1>Bitcoin value from coindesk.com</h1>
            <span>

                <div id="outputBitcoin"><button onclick="readJSON()">Check</button></div>
            </span>
        </section>
    </main>

    <footer>
        <!-- This section holds links to the external websites -->
        <div class="links">
            <div style="width: 600px; margin-left: auto; margin-right: auto;">
                <div class="gmit">
                    <a href="https://www.gmit.ie/" class="link" target="_blank"> GMIT </a>
                </div>
                <div class="gh">
                    <a href="https://github.com/andkoc001" class="link" target="_blank"> GitHub </a>
                </div>
                <div class="pa">
                    <a href="http://andkoc001.pythonanywhere.com/" class="link" target="_blank"> PythonAnywhere </a>
                </div>
                <div style="clear:both"></div>
            </div>
        </div>

        <div class="info">
            Andrzej Kocielski (G00376291@gmit.ie), 2020
        </div>
    </footer>

    <!-- This button appears when the page is scrolled down bt 50px (see the Java Script file) and, when clicked, brings the web page back to the top -->
    <button onclick="topFunction()" id="toTop" title="Top">Go to Top</button>
</body>

<script>

    // ////////////////////
    // Table CRUD manipulation

    function showTable() {
        document.getElementById('showCreateButton').style.display = "inline"
        document.getElementById('equipmentTable').style.display = "table"
        document.getElementById('createUpdateForm').style.display = "none"
        document.getElementById('createLabel').style.display = "inline"
        document.getElementById('updateLabel').style.display = "none"
        document.getElementById('doCreateButton').style.display = "none"
        document.getElementById('doUpdateButton').style.display = "none"
        document.getElementById('showExportButton').style.display = "block"
    }

    function showCreate() {
        document.getElementById('showCreateButton').style.display = "none"
        document.getElementById('equipmentTable').style.display = "none"
        document.getElementById('createUpdateForm').style.display = "block"
        document.getElementById('createLabel').style.display = "inline"
        document.getElementById('updateLabel').style.display = "none"
        document.getElementById('doCreateButton').style.display = "block"
        document.getElementById('doUpdateButton').style.display = "none"
        document.getElementById('showExportButton').style.display = "none"
    }


    function showViewAll() {
        document.getElementById('showCreateButton').style.display = "block"
        document.getElementById('equipmentTable').style.display = "table"
        document.getElementById('createUpdateForm').style.display = "none"
    }


    function showUpdate(buttonElement) {
        document.getElementById('showCreateButton').style.display = "none"
        document.getElementById('equipmentTable').style.display = "none"
        document.getElementById('createUpdateForm').style.display = "block"
        document.getElementById('createLabel').style.display = "none"
        document.getElementById('updateLabel').style.display = "inline"
        document.getElementById('doCreateButton').style.display = "none"
        document.getElementById('doUpdateButton').style.display = "block"
        document.getElementById('showExportButton').style.display = "none"

        var rowElement = buttonElement.parentNode.parentNode
        // these is a way of finding the closest <tr> which would safer, closest()
        var equipment = getEquipmentFromRow(rowElement)
        populateFormWithEquipment(equipment)
    }


    function doCreate() {
        var form = document.getElementById('createUpdateForm')
        var equipment = {}
        console.log("inside doCreate function:")
        console.log(JSON.stringify(equipment)) // for testing
        equipment.category = form.querySelector('select[placeholder="Category"]').value
        equipment.name = form.querySelector('input[placeholder="Name"]').value
        equipment.supplier = form.querySelector('input[placeholder="Supplier"]').value
        equipment.price_eur = form.querySelector('input[placeholder="Price EUR"]').value
        console.log(JSON.stringify(equipment)) // for testing
        createEquipmentAjax(equipment)
        showViewAll()
    }


    function doUpdate() {
        console.log("inside doUpdate function");
        var equipment = getEquipmentFromForm();
        var rowElement = document.getElementById(equipment.id);
        console.log("inside doUpdate function - will do updateEquipmentAjax in the next line");
        console.log(JSON.stringify(equipment));
        updateEquipmentAjax(equipment);
        setEquipmentInRow(rowElement, equipment);
        clearForm();
        showViewAll();
    }


    function doDelete(r) {
        var tableElement = document.getElementById('equipmentTable');
        var rowElement = r.parentNode.parentNode;
        var index = rowElement.rowIndex;
        deleteEquipmentAjax(rowElement.getAttribute("id"));
        tableElement.deleteRow(index);
    }

    function doExport() {
        var equipmentList = document.getElementById('equipmentTable');
        exportAjax()
    }


    function addEquipmentToTable(equipment) {
        var tableElement = document.getElementById('equipmentTable')
        var rowElement = tableElement.insertRow(-1)
        rowElement.setAttribute('id', equipment.id)
        var cell1 = rowElement.insertCell(0);
        cell1.innerHTML = equipment.id
        var cell2 = rowElement.insertCell(1);
        cell2.innerHTML = equipment.category
        var cell3 = rowElement.insertCell(2);
        cell3.innerHTML = equipment.name
        var cell4 = rowElement.insertCell(3);
        cell4.innerHTML = equipment.supplier
        var cell5 = rowElement.insertCell(4);
        cell5.innerHTML = parseFloat(equipment.price_eur).toFixed(2)
        /*
        var cell6 = rowElement.insertCell(5); //
        cell6.innerHTML = '<button class="checkBitcoin" onclick="checkBitcoin(this)">Check</button>'
        */
        var cell6 = rowElement.insertCell(5);
        cell6.innerHTML = '<button class="table_entry_update" onclick="showUpdate(this)">Update</button>'
        var cell7 = rowElement.insertCell(6);
        cell7.innerHTML = '<button class="table_entry_delete" onclick="doDelete(this)">Delete</button>'
    }


    function clearForm() {
        var form = document.getElementById('createUpdateForm')
        form.querySelector('select[placeholder="Category"]').value = ''
        form.querySelector('input[placeholder="Name"]').value = ''
        form.querySelector('input[placeholder="Supplier"]').value = ''
        form.querySelector('input[placeholder="Price EUR"]').value = ''
    }


    function getEquipmentFromRow(rowElement) {
        var equipment = {}
        equipment.id = rowElement.getAttribute('id')
        equipment.category = rowElement.cells[1].firstChild.textContent
        equipment.name = rowElement.cells[2].firstChild.textContent
        equipment.supplier = rowElement.cells[3].firstChild.textContent
        equipment.price_eur = parseFloat(rowElement.cells[4].firstChild.textContent, 2)
        console.log(equipment)
        return equipment
    }


    function setEquipmentInRow(rowElement, equipment) {
        rowElement.cells[0].firstChild.textContent = equipment.id
        rowElement.cells[1].firstChild.textContent = equipment.category
        rowElement.cells[2].firstChild.textContent = equipment.name
        rowElement.cells[3].firstChild.textContent = equipment.supplier
        rowElement.cells[4].firstChild.textContent = parseFloat(equipment.price_eur).toFixed(2)
    }


    function populateFormWithEquipment(equipment) {
        var form = document.getElementById('createUpdateForm')
        console.log(form)
        form.querySelector('input[name="id"]').disabled = true
        form.querySelector('input[name="id"]').value = equipment.id
        form.querySelector('select[placeholder="Category"]').value = equipment.category
        form.querySelector('input[placeholder="Name"]').value = equipment.name
        form.querySelector('input[placeholder="Supplier"]').value = equipment.supplier
        form.querySelector('input[placeholder="Price EUR"]').value = equipment.price_eur
        return equipment
    }


    function getEquipmentFromForm() {
        var form = document.getElementById('createUpdateForm')
        var equipment = {}
        // console.log("AAAAAA, id:")
        equipment.id = form.querySelector('input[name="id"]').value
        // console.log(equipment.id)
        // console.log("AAAAAA, category:")
        equipment.category = form.querySelector('select[placeholder="Category"]').value
        // console.log(equipment.category)
        // console.log("AAAAAA, name:")
        equipment.name = form.querySelector('input[placeholder="Name"]').value
        // console.log(equipment.name)
        // console.log("AAAAAA, supplier:")
        equipment.supplier = form.querySelector('input[placeholder="Supplier"]').value
        // console.log(equipment.supplier)
        // console.log("AAAAAA, price:")
        equipment.price_eur = parseFloat(form.querySelector('input[placeholder="Price EUR"]').value).toFixed(2)
        // console.log(equipment.price_eur)
        // console.log("inside getEquipmentFromForm, next line prints equipment")
        // console.log(JSON.stringify(equipment))
        // console.log("still inside getEquipmentFromForm")
        return equipment
    }

    // ////////////////////
    // AJAX 

    host = window.location.origin

    function exportAjax() {
        $.ajax({
            "url": host + "/equipment",
            "method": "GET",
            "data": "",
            "dataType": "JSON",
            "success": function (result) {
                // console.log(result);
                for (equipment of result) {
                    console.log(equipment);
                }
            },
            "error": function (xhr, status, error) {
                console.log("error: " + status + " msg:" + error);
            }
        });
    }



    function getAllAjax() {
        $.ajax({
            "url": host + "/equipment",
            "method": "GET",
            "data": "",
            "dataType": "JSON",
            "success": function (result) {
                //console.log(result);
                for (equipment of result) {
                    addEquipmentToTable(equipment);
                }
            },
            "error": function (xhr, status, error) {
                console.log("error: " + status + " msg:" + error);
            }
        });
    }


    function createEquipmentAjax(equipment) {
        console.log("inside createEquipmentAjax function:")
        console.log(JSON.stringify(equipment)); // for testing
        $.ajax({
            "url": host + "/equipment",
            "method": "POST",
            "data": JSON.stringify(equipment),
            "dataType": "JSON",
            contentType: "application/json; charset=utf-8",
            "success": function (result) {
                console.log(result);
                equipment.id = result.id
                addEquipmentToTable(equipment)
                clearForm()
                showViewAll()
            },
            "error": function (xhr, status, error) {
                console.log("error: " + status + " msg:" + error);
            }
        });
    }


    function updateEquipmentAjax(equipment) {
        console.log("inside updateEqimpmentAjax function");
        console.log(JSON.stringify(equipment));
        $.ajax({
            "url": host + "/equipment/" + encodeURI(equipment.id),
            "method": "PUT",
            "data": JSON.stringify(equipment),
            //"data": buildQuery(equipment),
            "dataType": "JSON",
            contentType: "application/json; charset=utf-8",
            "success": function (result) {
                console.log(result);
            },
            "error": function (xhr, status, error) {
                console.log("error: " + status + " msg: " + error);
            }
        });
    }


    function deleteEquipmentAjax(id) {

        //console.log(JSON.stringify('deleting '+id));
        $.ajax({
            "url": host + "/equipment/" + encodeURI(id),
            "method": "DELETE",
            "data": "",
            "dataType": "JSON",
            contentType: "application/json; charset=utf-8",
            "success": function (result) {
                //console.log(result);

            },
            "error": function (xhr, status, error) {
                console.log("error: " + status + " msg:" + error);
            }
        });
    }
    getAllAjax();


    function readJSON() {
        $.ajax({
            "url": "https://api.coindesk.com/v1/bpi/currentprice.json ",
            "method": "GET",
            "data": "",
            "dataType": "JSON",
            "success": function (result) {
                //console.log(result);
                var rate = result.bpi.EUR.rate
                document.getElementById("outputBitcoin").innerText = rate;
            },
            "error": function (xhr, status, error) {
                //console.log("error: " + status + " msg:" + error);
                var rate = result.bpi.EUR.rate
                document.getElementById("outputBitcoin").innerText = rate;
            }
        });
    }

    // from https://stackoverflow.com/a/16017283
    function buildQuery(obj) {
        var Result = '';
        if (typeof (obj) == 'object') {
            jQuery.each(obj, function (key, value) {
                Result += (Result) ? '&' : '';
                if (typeof (value) == 'object' && value.length) {
                    for (var i = 0; i < value.length; i++) {
                        Result += [key + '[]', encodeURIComponent(value[i])].join('=');
                    }
                } else {
                    Result += [key, encodeURIComponent(value)].join('=');
                }
            });
        }
        console.log("inside buildQuery")
        return Result;
    }

    // ////////////////////
    // Scroll up to top of page functionality
    // Adopted from: https://www.w3schools.com/howto/howto_js_scroll_to_top.asp

    // Get signal from the button
    var mybutton = document.getElementById("toTop");

    // The button appears when the user scrolls down 50px from the top of the document
    window.onscroll = function () { scrollFunction() };
    function scrollFunction() {
        if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
            mybutton.style.display = "block";
        } else {
            mybutton.style.display = "none";
        }
    }

    // When the user clicks on the button, scroll to the top of the document
    function topFunction() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    }

</script>

</html>